DROP TABLE IF EXISTS Samples;

CREATE TABLE Samples
(sample_time TIMESTAMP NOT NULL PRIMARY KEY,
 moving_avg REAL DEFAULT 0 NOT NULL ,
 load REAL DEFAULT 0 NOT NULL);

INSERT INTO Samples VALUES('2007-01-01 01:00', 0, 0);
INSERT INTO Samples VALUES('2007-01-01 01:15', 0, 1);
INSERT INTO Samples VALUES('2007-01-01 01:30', 0, 2);
INSERT INTO Samples VALUES('2007-01-01 01:45', 0, 3);
INSERT INTO Samples VALUES('2007-01-01 02:00', 0, 4);
INSERT INTO Samples VALUES('2007-01-01 02:15', 0, 5);
INSERT INTO Samples VALUES('2007-01-01 02:30', 0, 6);

SELECT moving_avg
FROM (
  SELECT 
    AVG(load) OVER (ORDER BY sample_time ROWS BETWEEN CURRENT ROW AND 3 FOLLOWING) AS moving_avg,
    COUNT(*) OVER (ORDER BY sample_time ROWS BETWEEN CURRENT ROW AND 3 FOLLOWING) AS cnt
  FROM Samples
) t
WHERE cnt = 4


